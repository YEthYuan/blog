<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Relational Database Management System (RDBMS) Scaling - I | Ye Yuan's Blog</title><meta name="author" content="Ye Yuan"><meta name="copyright" content="Ye Yuan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="MotivationYou have your web application running on EC2. It is becoming increasingly popular and performance is degrading. What do you do? Handling Concurrent RequestsYou have deployed application serv">
<meta property="og:type" content="article">
<meta property="og:title" content="Relational Database Management System (RDBMS) Scaling - I">
<meta property="og:url" content="https://blog.yeyuan.pro/posts/2022/cs291a-rdbms-scaling-i.html">
<meta property="og:site_name" content="Ye Yuan&#39;s Blog">
<meta property="og:description" content="MotivationYou have your web application running on EC2. It is becoming increasingly popular and performance is degrading. What do you do? Handling Concurrent RequestsYou have deployed application serv">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://picsum.photos/1920/1080?blur=2&random=5">
<meta property="article:published_time" content="2022-11-14T17:48:10.000Z">
<meta property="article:modified_time" content="2023-04-14T22:42:34.135Z">
<meta property="article:author" content="Ye Yuan">
<meta property="article:tag" content="EN">
<meta property="article:tag" content="UCSB">
<meta property="article:tag" content="CS291A">
<meta property="article:tag" content="Database">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://picsum.photos/1920/1080?blur=2&random=5"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://blog.yeyuan.pro/posts/2022/cs291a-rdbms-scaling-i"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-KTYXD67M5V"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-KTYXD67M5V');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: {"limitDay":500,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":50,"languages":{"author":"Author: Ye Yuan","link":"Link: ","source":"Source: Ye Yuan's Blog","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Relational Database Management System (RDBMS) Scaling - I',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-04-14 22:42:34'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="Ye Yuan's Blog" type="application/atom+xml">
</head><body><link rel="stylesheet" href="/css/custom/center-radar.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">12</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">13</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">7</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://yeyuan.pro/#about"><i class="fa-fw fa-solid fa-user"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://picsum.photos/1920/1080?blur=2&amp;random=5')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Ye Yuan's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://yeyuan.pro/#about"><i class="fa-fw fa-solid fa-user"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Relational Database Management System (RDBMS) Scaling - I</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-11-14T17:48:10.000Z" title="Created 2022-11-14 17:48:10">2022-11-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-04-14T22:42:34.135Z" title="Updated 2023-04-14 22:42:34">2023-04-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Database/">Database</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">1.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>6min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Relational Database Management System (RDBMS) Scaling - I"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Motivation"><a href="#Motivation" class="headerlink" title="Motivation"></a>Motivation</h1><p>You have your web application running on EC2. It is becoming increasingly popular and performance is degrading. <em>What do you do?</em></p>
<h2 id="Handling-Concurrent-Requests"><a href="#Handling-Concurrent-Requests" class="headerlink" title="Handling Concurrent Requests"></a>Handling Concurrent Requests</h2><p>You have deployed application servers that can serve many concurrent requests. But as your site’s popularity continues to grow that is not sufficient.</p>
<p><img src="https://yeyuan.pro/img/202211142225820.png" alt="Concurrent Requests"></p>
<h2 id="Vertical-Scaling"><a href="#Vertical-Scaling" class="headerlink" title="Vertical Scaling"></a>Vertical Scaling</h2><p><img src="https://yeyuan.pro/img/202211142225821.png" alt="Vertical Scaling"></p>
<p>You have increased your instance sizes and handled more load. However, as the popularity continues to grow you are no longer able to continue scaling vertically.</p>
<h2 id="Horizontal-Scaling"><a href="#Horizontal-Scaling" class="headerlink" title="Horizontal Scaling"></a>Horizontal Scaling</h2><p>You have introduced a load balancer that distributes traffic across a pool of application servers. Nevertheless, as the traffic continues to increase, additional horizontal scaling of the application servers does not solve the problem.</p>
<p><img src="https://yeyuan.pro/img/202211142225822.png" alt="Horizontal Scaling"></p>
<h2 id="Caching"><a href="#Caching" class="headerlink" title="Caching"></a>Caching</h2><p>You have properly configured HTTP caching such that unnecessary requests never happen. You are also caching heavyweight database operations. But it is still not enough to handle the increased load of your popular site.</p>
<h2 id="SQL-Structure-and-Query-Optimization"><a href="#SQL-Structure-and-Query-Optimization" class="headerlink" title="SQL Structure and Query Optimization"></a>SQL Structure and Query Optimization</h2><p>You have reduced the number of queries your application servers makes to the database. You have used <code>EXPLAIN</code> to discover indexes to add, and to ensure your most common SQL queries are as optimal as possible. However, your database is still a bottleneck.</p>
<h2 id="Non-trivial-DB-Horizontal-Scaling"><a href="#Non-trivial-DB-Horizontal-Scaling" class="headerlink" title="Non-trivial DB Horizontal Scaling"></a>Non-trivial DB Horizontal Scaling</h2><blockquote>
<p>Can we horizontally scale the database by adding more database servers and accessing them through a load balancer?</p>
</blockquote>
<p>Unfortunately, it’s not that simple. Horizontal scaling works great for <code>stateless</code> services. However, the database contains the state of our application, thus is not trivial to horizontally scale.</p>
<p>Note: Horizontally scaling databases in this way works fine for read-only operations.</p>
<p><img src="https://yeyuan.pro/img/202211142225823.png" alt="Database Horizontal Scaling Problem"></p>
<h2 id="Scaling-Relational-Databases"><a href="#Scaling-Relational-Databases" class="headerlink" title="Scaling Relational Databases"></a>Scaling Relational Databases</h2><ul>
<li>Sharding</li>
<li>Service Oriented Architectures (SOA)</li>
<li>Separating Reads from Writes</li>
</ul>
<h1 id="Partitioning-Sharding"><a href="#Partitioning-Sharding" class="headerlink" title="Partitioning (Sharding)"></a>Partitioning (Sharding)</h1><p>Take a single database and <strong><em>split/partition/shard</em></strong> it up into multiple smaller databases such that everything still works.</p>
<blockquote>
<p>How do we handle joins across partitioned data?</p>
</blockquote>
<h2 id="Joins"><a href="#Joins" class="headerlink" title="Joins"></a>Joins</h2><p>Any particular database join connects a small part of your database. However, transitively, database joins could connect everything together.</p>
<blockquote>
<p><strong>E.g. Demo App:</strong> </p>
<ul>
<li>Any comment is only related to its parent (if not top-level), its children (replies), and its submission.</li>
<li>Submissions relate to each other through communities.</li>
<li>Transitively, all of these relationships could be joined across.</li>
</ul>
</blockquote>
<h2 id="Separating-Data"><a href="#Separating-Data" class="headerlink" title="Separating Data"></a>Separating Data</h2><p>Find a separation of your data that ideally produces unrelated (not joined across) <em>partitions</em>. Once separated, your application cannot utilize the database to join across partitions. If you need to perform operations across sharded data, you will need to do it at the application level. Consider the performance trade-offs. Could you partition another way?</p>
<p><img src="https://yeyuan.pro/img/202211142225824.png" alt="Sharding"></p>
<h2 id="Similar-Data"><a href="#Similar-Data" class="headerlink" title="Similar Data"></a>Similar Data</h2><p>Partitioning involves splitting data of the same type (e.g., the rows of the tables).</p>
<p>For instance if we wanted to split our <code>Comments</code> table into two partitions, we could store comments belonging to half the submissions in <em>partition1</em>, and those belonging to the other half in <em>partition2</em>.</p>
<blockquote>
<p>What is not partitioning?</p>
</blockquote>
<p>Separating tables into their own databases is not partitioning. While this approach may work for some applications, the ability to join across tables is lost.</p>
<blockquote>
<p>How can we find what partition our data is on?</p>
</blockquote>
<p>We need some sort of mapping to determine where to find that data.</p>
<h3 id="At-the-App-Server"><a href="#At-the-App-Server" class="headerlink" title="At the App Server"></a>At the App Server</h3><p>Each application server contains a configuration that informs it of where each database is (IP address, DNS name) and how to map data to the database. The mapping can be arbitrarily complex. The mapping itself may even be stored in a database.</p>
<p><img src="https://yeyuan.pro/img/202211142225825.png" alt="App Server Sharding"></p>
<h3 id="At-the-load-balancer"><a href="#At-the-load-balancer" class="headerlink" title="At the load balancer"></a>At the load balancer</h3><p>The load balancer could be configured to route requests to the app servers that are configured to <em>talk</em> to the right database. Such mappings are limited by knowledge that the load balancer can inspect:</p>
<ul>
<li>Resource URI</li>
<li>Headers</li>
<li>Request Payload</li>
</ul>
<p><img src="https://yeyuan.pro/img/202211142225826.png" alt="Load Balancer Sharding"></p>
<h3 id="Across-Load-Balancers"><a href="#Across-Load-Balancers" class="headerlink" title="Across Load Balancers"></a>Across Load Balancers</h3><p>Host names (DNS) can be configured to point to the correct load balancer for a given request.</p>
<p>Examples:</p>
<ul>
<li>en.wikipedia.org vs. es.wikipedia.org (language based sharding)</li>
<li>google.com vs. google.co.uk (location based sharding)</li>
<li>na6.salesforce.com vs. naX.salesforce.com (customer based sharding)</li>
</ul>
<p><strong>Note</strong>: The above examples could involve only a single load balancer.</p>
<p><img src="https://yeyuan.pro/img/202211142225827.png" alt="Sharding Across Load Balancers"></p>
<h3 id="Trade-offs"><a href="#Trade-offs" class="headerlink" title="Trade-offs"></a>Trade-offs</h3><p>The approaches we just described are vary from providing more flexibility to providing more scalability.</p>
<ul>
<li>App Server (most flexible)</li>
<li>Load Balancer</li>
<li>DNS (most scalable)</li>
</ul>
<h2 id="Partitioning-and-Growth"><a href="#Partitioning-and-Growth" class="headerlink" title="Partitioning and Growth"></a>Partitioning and Growth</h2><p>Ideally the number of partitions increase as the usage of your application increases.</p>
<blockquote>
<p><strong>Examples</strong>:</p>
<ul>
<li>If each customer’s data can be partitioned from the others, then doubling the number of customers doubles the number of partitions.</li>
<li>The data that represent one user’s email conceptually requires no relation to the data representing other users’ email. When a request arrives associated with a particular user, the server applies some mapping function to determine which database the user’s data are located in. Should the email provider need to take down a database, they can relocate the partitioned data to another database, and update the mapping with little disruption.</li>
</ul>
</blockquote>
<h2 id="Partitioning-Demo-App"><a href="#Partitioning-Demo-App" class="headerlink" title="Partitioning Demo App"></a>Partitioning Demo App</h2><h3 id="Settings"><a href="#Settings" class="headerlink" title="Settings"></a>Settings</h3><ul>
<li>Users can create and view communities.</li>
<li>Users can create submissions in these communities.</li>
<li>Each submission has a tree of comments.</li>
</ul>
<blockquote>
<p>How can we partition this application?</p>
</blockquote>
<h3 id="By-User"><a href="#By-User" class="headerlink" title="By User?"></a>By User?</h3><p>This would have difficulty as logged in users will want to see communities, submissions, and comments made by other logged in users.</p>
<h3 id="By-Submission"><a href="#By-Submission" class="headerlink" title="By Submission?"></a>By Submission?</h3><p>This would make generating submission lists for a single community difficult.</p>
<h3 id="By-Community"><a href="#By-Community" class="headerlink" title="By Community?"></a>By Community?</h3><h4 id="Methodology"><a href="#Methodology" class="headerlink" title="Methodology"></a>Methodology</h4><p>Obtaining a community list will be more difficult, but cleanly partitioning comments and submissions by their community is doable.</p>
<blockquote>
<p>How could we make community based paritioning work?</p>
</blockquote>
<p>We can use information in the url with any of the load balancing approaches.</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://ucsb.demo.com/">http://ucsb.demo.com</a> (community sub-domain)</li>
<li><a target="_blank" rel="noopener" href="http://demo.com/ucsb">http://demo.com/ucsb</a> (community path)</li>
</ul>
<p>Either the application server connects to the right database for the <code>ucsb</code> community, or DNS/loadbalancer directs the request to an application server that always talks to the <code>ucsb</code> containing database.</p>
<h4 id="Difficulty"><a href="#Difficulty" class="headerlink" title="Difficulty"></a>Difficulty</h4><ul>
<li>The global list of submissions.</li>
<li>List of submissions by user.</li>
<li>List of comments by user.</li>
</ul>
<blockquote>
<p>What can we do to resolve these issues?</p>
</blockquote>
<p><img src="https://yeyuan.pro/img/202211142225828.png" alt="Sharding Global Submission View"></p>
<h4 id="Solving-Partitioning-Problems"><a href="#Solving-Partitioning-Problems" class="headerlink" title="Solving Partitioning Problems"></a>Solving Partitioning Problems</h4><ul>
<li>Modify the user interface such that the difficult to partition page does not exist. only providing the list of communities</li>
<li>Alternatively, periodically run an expensive background job to keep a semi-up-to-date global submission list aggregating results from across databases.</li>
</ul>
<h2 id="Partitioning-in-Rails"><a href="#Partitioning-in-Rails" class="headerlink" title="Partitioning in Rails"></a>Partitioning in Rails</h2><p>Rails 6+ has built-in support for partitioning: <a target="_blank" rel="noopener" href="https://guides.rubyonrails.org/active_record_multiple_databases.html">https://guides.rubyonrails.org/active_record_multiple_databases.html</a></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">index</span></span><br><span class="line">    ...</span><br><span class="line">    ActiveRecord::Base.connected_to(<span class="symbol">database:</span> <span class="symbol">:customer1</span>)</span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2 id="Partitioning-Trade-offs-Summary"><a href="#Partitioning-Trade-offs-Summary" class="headerlink" title="Partitioning Trade-offs - Summary"></a>Partitioning Trade-offs - Summary</h2><h3 id="Strengths"><a href="#Strengths" class="headerlink" title="Strengths"></a>Strengths</h3><ul>
<li>If you genuinely have zero relations across partitions, this scaling path is very powerful.</li>
<li>Partitioning works best when partitions grow with usage.</li>
</ul>
<h3 id="Weaknesses"><a href="#Weaknesses" class="headerlink" title="Weaknesses"></a>Weaknesses</h3><ul>
<li>Partitioning can inhibit feature development. That is your application may be perfectly partitionable today, but future features may change that. <strong>(Partitioning is scalable, but not flexible)</strong></li>
<li>Not easy to retroactively add partitioning to an existing application.</li>
<li>Transactions across partitions do not exist.</li>
<li>Consistent DB snapshots across partitions do not exist.</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://yethyuan.github.io/">Ye Yuan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.yeyuan.pro/posts/2022/cs291a-rdbms-scaling-i.html">https://blog.yeyuan.pro/posts/2022/cs291a-rdbms-scaling-i.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/EN/">EN</a><a class="post-meta__tags" href="/tags/UCSB/">UCSB</a><a class="post-meta__tags" href="/tags/CS291A/">CS291A</a><a class="post-meta__tags" href="/tags/Database/">Database</a></div><div class="post_share"><div class="social-share" data-image="https://picsum.photos/1920/1080?blur=2&amp;random=5" data-sites="facebook,twitter,wechat,weibo,qq,google"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/2022/cs291a-rdbms-scaling-ii.html"><img class="prev-cover" src="https://picsum.photos/1920/1080?blur=2&amp;random=7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Relational Database Management System (RDBMS) Scaling - II</div></div></a></div><div class="next-post pull-right"><a href="/posts/2022/cs291a-concurrency-control-in-rails.html"><img class="next-cover" src="https://picsum.photos/1920/1080?blur=2&amp;random=1" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Concurrency Control in Rails</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/posts/2022/cs291a-nosql.html" title="Non-Relational Data Stores (NoSQL)"><img class="cover" src="https://picsum.photos/1920/1080?blur=2&random=1" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-14</div><div class="title">Non-Relational Data Stores (NoSQL)</div></div></a></div><div><a href="/posts/2022/cs291a-rdbms-scaling-ii.html" title="Relational Database Management System (RDBMS) Scaling - II"><img class="cover" src="https://picsum.photos/1920/1080?blur=2&random=7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-14</div><div class="title">Relational Database Management System (RDBMS) Scaling - II</div></div></a></div><div><a href="/posts/2022/cs291a-relational-databases-i.html" title="Relational Databases - I"><img class="cover" src="https://picsum.photos/1920/1080?blur=2&random=8" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-13</div><div class="title">Relational Databases - I</div></div></a></div><div><a href="/posts/2022/cs291a-relational-databases-ii.html" title="Relational Databases - II"><img class="cover" src="https://picsum.photos/1920/1080?blur=2&random=10" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-13</div><div class="title">Relational Databases - II</div></div></a></div><div><a href="/posts/2022/cs291a-concurrency-control-in-rails.html" title="Concurrency Control in Rails"><img class="cover" src="https://picsum.photos/1920/1080?blur=2&random=1" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-13</div><div class="title">Concurrency Control in Rails</div></div></a></div><div><a href="/posts/2022/cs291a-tsung-load-testing.html" title="Load Testing With Tsung"><img class="cover" src="https://picsum.photos/1920/1080?blur=2&random=1" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-14</div><div class="title">Load Testing With Tsung</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Ye Yuan</div><div class="author-info__description">A record of learnings in CS</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">12</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">13</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">7</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/YEthYuan"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="/" target="_blank" title="Home"><i class="fa-solid fa-house-chimney"></i></a><a class="social-icon" href="https://yeyuan.pro/" target="_blank" title="About me"><i class="fa-solid fa-user"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa-solid fa-square-rss"></i></a><a class="social-icon" href="mailto:maxwell.yuanyeh@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://scholar.google.com/citations?hl=en&amp;user=HjmRtpQAAAAJ" target="_blank" title="Google Scholar"><i class="fa-solid fa-graduation-cap"></i></a><a class="social-icon" href="https://www.linkedin.com/in/yethyuan" target="_blank" title="LinkedIn"><i class="fa-brands fa-linkedin"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">I'm actively looking for Summer 2023 Software Development Engineer Intern opportunities! Feel free to contact me at hire@yeyuan.pro</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Motivation"><span class="toc-number">1.</span> <span class="toc-text">Motivation</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Handling-Concurrent-Requests"><span class="toc-number">1.1.</span> <span class="toc-text">Handling Concurrent Requests</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vertical-Scaling"><span class="toc-number">1.2.</span> <span class="toc-text">Vertical Scaling</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Horizontal-Scaling"><span class="toc-number">1.3.</span> <span class="toc-text">Horizontal Scaling</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Caching"><span class="toc-number">1.4.</span> <span class="toc-text">Caching</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL-Structure-and-Query-Optimization"><span class="toc-number">1.5.</span> <span class="toc-text">SQL Structure and Query Optimization</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Non-trivial-DB-Horizontal-Scaling"><span class="toc-number">1.6.</span> <span class="toc-text">Non-trivial DB Horizontal Scaling</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Scaling-Relational-Databases"><span class="toc-number">1.7.</span> <span class="toc-text">Scaling Relational Databases</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Partitioning-Sharding"><span class="toc-number">2.</span> <span class="toc-text">Partitioning (Sharding)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Joins"><span class="toc-number">2.1.</span> <span class="toc-text">Joins</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Separating-Data"><span class="toc-number">2.2.</span> <span class="toc-text">Separating Data</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Similar-Data"><span class="toc-number">2.3.</span> <span class="toc-text">Similar Data</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#At-the-App-Server"><span class="toc-number">2.3.1.</span> <span class="toc-text">At the App Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#At-the-load-balancer"><span class="toc-number">2.3.2.</span> <span class="toc-text">At the load balancer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Across-Load-Balancers"><span class="toc-number">2.3.3.</span> <span class="toc-text">Across Load Balancers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Trade-offs"><span class="toc-number">2.3.4.</span> <span class="toc-text">Trade-offs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Partitioning-and-Growth"><span class="toc-number">2.4.</span> <span class="toc-text">Partitioning and Growth</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Partitioning-Demo-App"><span class="toc-number">2.5.</span> <span class="toc-text">Partitioning Demo App</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Settings"><span class="toc-number">2.5.1.</span> <span class="toc-text">Settings</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#By-User"><span class="toc-number">2.5.2.</span> <span class="toc-text">By User?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#By-Submission"><span class="toc-number">2.5.3.</span> <span class="toc-text">By Submission?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#By-Community"><span class="toc-number">2.5.4.</span> <span class="toc-text">By Community?</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Methodology"><span class="toc-number">2.5.4.1.</span> <span class="toc-text">Methodology</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Difficulty"><span class="toc-number">2.5.4.2.</span> <span class="toc-text">Difficulty</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Solving-Partitioning-Problems"><span class="toc-number">2.5.4.3.</span> <span class="toc-text">Solving Partitioning Problems</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Partitioning-in-Rails"><span class="toc-number">2.6.</span> <span class="toc-text">Partitioning in Rails</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Partitioning-Trade-offs-Summary"><span class="toc-number">2.7.</span> <span class="toc-text">Partitioning Trade-offs - Summary</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Strengths"><span class="toc-number">2.7.1.</span> <span class="toc-text">Strengths</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Weaknesses"><span class="toc-number">2.7.2.</span> <span class="toc-text">Weaknesses</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/2022/cs291a-nosql.html" title="Non-Relational Data Stores (NoSQL)"><img src="https://picsum.photos/1920/1080?blur=2&amp;random=1" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Non-Relational Data Stores (NoSQL)"/></a><div class="content"><a class="title" href="/posts/2022/cs291a-nosql.html" title="Non-Relational Data Stores (NoSQL)">Non-Relational Data Stores (NoSQL)</a><time datetime="2022-11-14T23:00:45.000Z" title="Created 2022-11-14 23:00:45">2022-11-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2022/cs291a-tsung-load-testing.html" title="Load Testing With Tsung"><img src="https://picsum.photos/1920/1080?blur=2&amp;random=1" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Load Testing With Tsung"/></a><div class="content"><a class="title" href="/posts/2022/cs291a-tsung-load-testing.html" title="Load Testing With Tsung">Load Testing With Tsung</a><time datetime="2022-11-14T22:28:33.000Z" title="Created 2022-11-14 22:28:33">2022-11-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2022/cs291a-rdbms-scaling-ii.html" title="Relational Database Management System (RDBMS) Scaling - II"><img src="https://picsum.photos/1920/1080?blur=2&amp;random=7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Relational Database Management System (RDBMS) Scaling - II"/></a><div class="content"><a class="title" href="/posts/2022/cs291a-rdbms-scaling-ii.html" title="Relational Database Management System (RDBMS) Scaling - II">Relational Database Management System (RDBMS) Scaling - II</a><time datetime="2022-11-14T19:48:10.000Z" title="Created 2022-11-14 19:48:10">2022-11-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2022/cs291a-rdbms-scaling-i.html" title="Relational Database Management System (RDBMS) Scaling - I"><img src="https://picsum.photos/1920/1080?blur=2&amp;random=5" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Relational Database Management System (RDBMS) Scaling - I"/></a><div class="content"><a class="title" href="/posts/2022/cs291a-rdbms-scaling-i.html" title="Relational Database Management System (RDBMS) Scaling - I">Relational Database Management System (RDBMS) Scaling - I</a><time datetime="2022-11-14T17:48:10.000Z" title="Created 2022-11-14 17:48:10">2022-11-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2022/cs291a-concurrency-control-in-rails.html" title="Concurrency Control in Rails"><img src="https://picsum.photos/1920/1080?blur=2&amp;random=1" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Concurrency Control in Rails"/></a><div class="content"><a class="title" href="/posts/2022/cs291a-concurrency-control-in-rails.html" title="Concurrency Control in Rails">Concurrency Control in Rails</a><time datetime="2022-11-13T19:16:34.000Z" title="Created 2022-11-13 19:16:34">2022-11-13</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://picsum.photos/1920/1080?blur=2&amp;random=5')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Ye Yuan</div><div class="footer_custom_text">Make the world a better place</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script><script>function loadGiscus () {
  let nowTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  const config = Object.assign({
    src: 'https://giscus.app/client.js',
    'data-repo': 'YEthYuan/blog',
    'data-repo-id': 'R_kgDOG_mEtg',
    'data-category-id': 'DIC_kwDOG_mEts4CSaaF',
    'data-mapping': 'pathname',
    'data-theme': nowTheme,
    'data-reactions-enabled': '1',
    crossorigin: 'anonymous',
    async: true
  },null)

  let ele = document.createElement('script')
  for (let key in config) {
    ele.setAttribute(key, config[key])
  }
  document.getElementById('giscus-wrap').insertAdjacentElement('afterbegin',ele)
}

function changeGiscusTheme () {
  const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'

  function sendMessage(message) {
    const iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe) return;
    iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
  }

  sendMessage({
    setConfig: {
      theme: theme
    }
  });
}

if ('Giscus' === 'Giscus' || !true) {
  if (true) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
  else loadGiscus()
} else {
  function loadOtherComment () {
    loadGiscus()
  }
}</script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":false,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.8},"log":false});</script></body></html>